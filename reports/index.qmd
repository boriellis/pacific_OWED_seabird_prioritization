---
output: html_document
format: 
  html:
    css: styles.css
execute:
  echo: false
  warning: false  # Suppress warnings
  message: false  # Suppress messages
editor_options: 
  chunk_output_type: console
---

# Species Prioritization Weight Testing

The point of this document is to explain each of the steps of the species prioritization framework for the California Current Ecosystem. This document is in progress.

## Step 1 - Selecting species present in the region to include

A literature review was performed to compile a list of all birds found regularly in the region. The initial list was acquired by combining the list from Kelsey et al. (2018) (detailed methods on the list formation can be found in Adams et al., 2016), which identified 81 regional marine bird species in the California Current System, with the list of species modeled by Leirness et al., 2021. The list was then refined according to the following additional criteria:\

-   The updated vulnerability index from Kelsey et al (in prep) includes eight additional species due to range shifts and taxonomic updates. We have followed suit and included these species here:

    -   Masked Booby, *Sula dactylatra*

        Nazca Booby, *Sula granti*

        Blue-footed Booby, *Sula nebouxii*

        Brown Booby, *Sula leucogaster*

        Red-footed Booby, *Sula sula*

        Red-billed Tropicbird, *Phaethon aethereus*

        Guadalupe Murrelet, *Synthliboramphus hypoleucus*

        Townsend’s Storm-Petrel, *Hydrobates socorroensis*

-   Species that were considered to have 1% or less of their global population utilizing the CCS by Adams et al 2016 and Kelsey et al 2018 were considered for exclusion from this list, as a metric to exclude vagrants. I have selected the 1% cutoff is based on precedent for use in definitions of [Birdlife International’s Important Bird Areas](http://datazone.birdlife.org/userfiles/images/Guidelines%20for%20the%20application%20of%20the%20IBA%20criteria_final%20approved%20version_July2020.pdf), the [EU Natura 2000 Site Guidelines for Marine Habitats](https://ec.europa.eu/environment/nature/natura2000/marine/docs/marine_guidelines.pdf). It was also used in [Desholm’s 2009](https://pubmed.ncbi.nlm.nih.gov/19299065/) prioritization framework for research needs for migratory birds in wind farms. These applications are all for definition of important bird areas at much finer scales than what we’re discussing here, but as I am here recommending that the 1% criteria be used simply as a first step for eliminating vagrants from regional consideration, I believe that it functions in this application as a tool to identify whether the region is important to a species globally.

    -   For all species with \<1% of global population estimated in the CCS, we performed literature review (primarily through the Cornell Birds of the World database) as a confirmation that the species is appropriate for exclusion. Local population estimates are frequently based on at-sea survey data that may be sufficient to identify certain types of important regional presence. Any species breeding in the CCS was included, even if local populations were small compared to global population sizes. Species known to have migratory pathways crossing the CCS were also included, as a precautionary measure given that brief periods of high bird presence during migration may be challenging to detect from at-sea survey data. Threatened species with poorly understood local area usage were also considered for inclusion.

Following the above steps, of the species that were considered in Leirness et al., 2021, Kelsey et al., 2018, and/or Kelsey et al., 2024, I opted to **exclude** the following species from this analysis for reasons described below:

-   **Wilson's Phalarope, *Phalaropus tricolor*** (Kelsey et al., 2018, 2024: N, Leirness et al., 2021: Y)

    -   Not included in original Kelsey et al., vulnerability index as the species does not typically use pelagic habitats. A handful of records from at-sea surveys meant that the species was modeled in the joint "Phalarope" model by Leirness et al., 2021. Excluded here because of very low offshore habitat usage (CITE).

-   **Short-tailed Shearwater, *Ardenna tenuirostris*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: Y)

    -   \<1% of global population considered to be in CCS by Kelsey et al 2018

    -   Included in joint Short-tailed, Flesh-footed, and Sooty Shearwater model by Leirness et al., 2021, based on low percentages of observations included in the model.

    -   Excluded because while data on local distribution is poor and outdated, there is no local breeding of the species and no known important migratory route through the CCS, just low usage in the non-breeding season (CITE)..

-   **Flesh-footed Shearwater, *Ardenna carneipes*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: Y)

    -   \<1% of global population considered to be in CCS by Kelsey et al 2018

    -   Included in joint Short-tailed, Flesh-footed, and Sooty Shearwater model by Leirness et al., 2021, based on low percentages of observations included in the model.

    -   Excluded because while data on local distribution is poor and outdated, there is no local breeding of the species and no known important migratory route through the CCS, just low usage in the non-breeding season (CITE).

-   **Arctic Loon, *Gavia arctica*** (Kelsey et al., 2018, 2024: N, Leirness et al., 2021: Y)

    -   This was formerly a subspecies of Pacific Loon, and is therefore only included in Leirness et al., 2021 as an artifact of the timing of the split. The species does not use the CCS (CITE).

-   **Common Tern, *Sterna hirundo*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: Y)

    -   \<1% of global population considered to be in CCS by Kelsey et al 2018

    -   Modeled as part of the Common Tern/Arctic Tern joint model by Leirness et al., 2021

    -   No breeding populations in the CCS, and no documented important migratory routes through offshore region (CITE).

-   **Royal Tern, *Thalasseus maximus*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: Y)

    -   \<1% of global population considered to be in CCS by Kelsey et al 2018

    -   Modeled as part of the Royal Tern/Elegant Tern joint model by Leirness et al., 2021

    -   Breeds irregularly in Southern California, but primarily uses inshore habitat; not considered highly pelagic (CITE).

-   **Horned Puffin, *Fratercula corniculata*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: N)

    -   \<1% of global population considered to be in CCS by Kelsey et al 2018

    -   Spend non-breeding season partially in pelagic CCS but not believed to overlap with the CCS in large numbers (CITE)

-   **Parakeet Auklet, *Aethia psittacula*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: N)

    -   \<1% of global population considered to be in CCS by Kelsey et al 2018

    -   Spend non-breeding season partially in pelagic CCS but not believed to overlap with the CCS in large numbers (CITE)

-   **Common Merganser, *Mergus merganser*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: N)

    -   \<1% of global population considered to be in CCS by Kelsey et al 2018

    -   Primarily use inshore and immediate coastal habitat (CITE).

-   **Red-breasted Merganser, *Mergus serrator*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: N)

    -   \<1% of global population considered to be in CCS by Kelsey et al 2018

    -   Primarily use inshore and immediate coastal habitat (CITE).

-   **Horned Grebe, *Podiceps auritus*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: N)

    -   \<1% of global population considered to be in CCS by Kelsey et al 2018

    -   Primarily use inshore and immediate coastal habitat (CITE).

-   **Long-tailed Duck, *Clangula hyemalis*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: N)

    -   \<1% of global population considered to be in CCS by Kelsey et al 2018

-   **Least Storm-Petrel, *Hydrobates microsoma*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: N)

    -   \<1% of global population considered to be in CCS by Kelsey et al 2018

    -   Occasionally found offshore as far north as central California in late summer but vast majority of population is in Gulf of California (CITE).

-   **Gull-billed Tern, *Gelochelidon nilotica*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: N)

    -   \<1% of global population considered to be in CCS by Kelsey et al 2018

    -   Primarily uses inshore habitat (CITE).

-   **Black Tern, *Chlidonias niger*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: N)

    -   \<1% of global population considered to be in CCS by Kelsey et al 2018

    -   Primarily uses inshore habitat, not found offshore in CCS (CITE).

-   **Wilson's Storm-Petrel, *Oceanites oceanicus*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: N)

    -   \<1% of global population considered to be in CCS by Kelsey et al 2018

    -   Uncommonly found in CCS in non-breeding season (CITE).

-   **American White Pelican, *Pelecanus erythrorhynchos*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: N)

    -   \<1% of global population considered to be in CCS by Kelsey et al 2018

    -   Not found in offshore habitat (CITE).

-   **Manx Shearwater, *Puffinus puffinus*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: N)

    -   \<1% of global population considered to be in CCS by Kelsey et al 2018

    -   Doesn't breed in region, only rarely found offshore (CITE).

The following table shows the exposure values, sensitivity values, and IUCN statuses for these species. Exposure and sensitivity values are each re-scaled to 1.

```{r}
# Load necessary libraries
suppressPackageStartupMessages(library(tidyverse)) # Suppress startup messages
library(knitr)
library(kableExtra) # Optional for further customization
library(tidyverse)
library(here)
#read in the csv:
df <- read.csv((here::here("data/processed_data/data_for_quarto.csv")))


# Select the relevant data: 
cleandf <- df %>% 
  filter(regional == "N") %>% 
  select(common_name, rescaled_propALL, rescaled_CV, rescaled_DV, iucn_status)

# Print the data frame as a styled table
kable(cleandf, format = "html", col.names = c("Species", "CCS Exposure", "Collision Sensitivity", "Displacement Sensitivity", "IUCN Status"), table.attr = 'class="table table-striped"') %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

The following species were **included** in the analysis despite a global population overlap with the CCS estimated by Kelsey et al., 2018 to be \<1%, for the reasons stated:

-   **Hawaiian Petrel, *Pterodroma sandwichensis*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: N)

    -   Included to be precautionary because of endangered IUCN status and an abundance of eBird sightings in recent years (CITE).

-   **Fork-tailed Storm-Petrel, *Hydrobates furcatus*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: Y)

    -   Included because the species breeds in the CCS (CITE).

-   **Parasitic Jaeger, *Stercorarius parasiticus*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: Y)

    -   Understood to migrate through the CCS, but limited research on movement and abundance data throughout the region (CITE) - included to be precautionary as migratory movements may be challenging to pick up in at-sea survey data.

-   **Long-tailed Jaeger, *Stercorarius longicaudus*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: Y)

    -   Understood to migrate through the CCS, but limited research on movement and abundance data throughout the region (CITE) - included to be precautionary as migratory movements may be challenging to pick up in at-sea survey data.

-   **Black Storm-Petrel, *Hydrobates melania*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: Y)

    -   Included because the species breeds in the CCS (CITE).

-   **Laysan Albatross, *Phoebastria immutabilis*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: Y)

    -   Included precautionarily given breeding population on Guadalupe Island and given proposed translocation to establish breeding colonies on the Channel Islands (Raine et al., 2022)

The following table shows the exposure values, sensitivity values, and IUCN statuses for these species. Again, exposure and sensitivity values are each re-scaled to 1.

```{r}
# Select the relevant data: 
cleandf <- df %>% 
  filter(CCSpop_Score == "1",
         regional == "Y") %>% 
  select(common_name, rescaled_propALL, rescaled_CV, rescaled_DV, iucn_status)

# Print the data frame as a styled table
kable(cleandf, format = "html", col.names = c("Species", "CCS Exposure", "Collision Sensitivity", "Displacement Sensitivity", "IUCN Status"), table.attr = 'class="table table-striped"') %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

## Step 2 - Getting values for exposure, sensitivity, and threat

### Exposure

The Leirness et al. (2021) species distribution maps of seabirds on the Pacific Outer Continental Shelf region were produced by season when enough data was present for a given species and season to produce a raster map with an estimate of density per km\^2 grid cell. To assess exposure over the course of the entire year, I have combined the models for each season available (assuming a zero presence in seasons not modeled) into an annual model. I then overlay the vector outlines of the wind energy areas under consideration and calculate what proportion much of the summed regional density is found within the development zones. Based on the way that the models are produced and the seasons are combined, this answer cannot be used to predict an actual number of individuals in any given grid cell, but can instead be interpreted as “In seasons that a species is present in the Pacific Outer Continental Shelf region, what proportion of the use of the region for that species overlaps with the development areas”.

Based on the size of the lease areas compared to the overall region (i.e., \~.159% of the POCS region modeled is within wind energy areas), these numbers are typically very small (i.e., the highest exposure value in the dataset is \~0.8% overlap with the development areas, for a Pink-Footed Shearwater).

Here is a complete list of the models produced by season. Some species were modeled in species groups instead of as individual species:

```{r}
#read in the csv:
modelcsv <- read.csv((here::here("reports/model_list.csv")))

modeltable <- modelcsv %>% 
  select(species_group, Spring, Summer, Fall, Winter)

# Print the data frame as a styled table
kable(modeltable, format = "html", col.names = c("Model Name", "Spring", "Summer", "Fall", "Winter"), table.attr = 'class="table table-striped"') %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

Observations of some species that were used to produce individual models were also used to create grouped models in some cases, particularly in the case of species groups with high numbers of unidentified observations:\
\
"*To the extent possible, species-specific models were developed. However, identification uncertainty for some species, mainly from visual aircraft-based surveys, may have increased the probability of species misidentification and also resulted in a greater proportion of observations not identified to species. Therefore, for some species, species-specific observations (e.g., Surf Scoter \[Melanitta perspicillata\]) were combined with species-nonspecific observations (e.g., unidentified scoter) to create broad taxonomic groups prior to modeling. Thirteen taxonomic groups were identified. In these cases, taxonomic group models were developed in place of individual species-level models. However, individual species models were developed in addition to taxonomic group models for Pomarine Jaeger (Stercorarius pomarinus), Red-throated Loon (Gavia stellata), and Common Loon (Gavia immer). Individual cormorant species models were developed for spring and summer seasons, when breeding plumage allowed species to be more easily distinguished. All cormorant observations were combined into a single taxonomic group for fall and winter season models.*" - Leirness et al., 2021

The tables below, copied from this report, outline the proportions of each grouped model that were made up of each species by season.

![](images/groups1.png)

![](images/groups2.png){width="1880"}

![](images/groups3.png)

Because our framework relies on treating each species individually given species-specific collision/displacement sensitivity scores and IUCN statuses, I have attempted to select the most appropriate model to use for each species, and intend to report on the caveats of each. Unfortunately, because densities cannot be compared across models, mixing models by season (e.g., using the Double-crested Cormorant model for Spring and Summer and supplementing with the Cormorant spp. model for Fall and Winter) is not a feasible approach.

-   **Sooty Shearwater** - used the Short-tailed/Sooty/Flesh-footed Shearwater model. This is effectively a Sooty Shearwater model in all seasons with a bit more messiness in the winter.

-   **Pomarine Jaeger** - This is the most abundant jaeger in the POCS, and was modeled separately for each season in addition to its observations being included in the grouped model given the high number of unidentified jaeger observations. I used the independent Pomarine Jaeger model.

-   **Parasitic Jaeger** - Given the high number of unidentified jaeger observations, observations of Parasitic Jaegers are modeled as a unit with Long-tailed Jaegers for all seasons and also used in the Jaeger spp. model. I'm using the Parasitic/Long-tailed Jaeger model here. Parasitic Jaegers are more abundant in the Spring and Winter models where overall jaeger observations are lower, and less abundant than Long-tailed Jaeger observations in the Summer and Fall, so this model is likely more representative of Long-tailed Jaeger distribution than Parasitic Jaeger abundance. This model is not produced for the Winter season, but observations in the Jaeger model are dominantly of Pomarine Jaegers.

-   **Long-tailed Jaeger** - I am using the Parasitic/Long-tailed Jaeger model here, which is likely more representative of Long-tailed Jaeger distribution than Parasitic (see above)

-   **Herring Gull** - I am using the Herring/Iceland Gull group model here. This model is almost entirely representative of Herring Gull distribution in all seasons.

-   **Iceland Gull** - I am using the Herring/Iceland Gull group model here. This model is almost entirely representative of Herring Gull distribution in all seasons. eBird observations appear to be potentially more concentrated in coastal areas for Iceland Gulls than for Herring Gulls, so this estimate may be precautionary.

-   **Arctic Tern** - I am using the Common/Arctic Tern model here. This model is majorly composed of Arctic Tern observations, though it contains more moderate numbers of Common Terns in the Spring season. Common Terns are not included in this framework for the reasons listed in section 1 of this overview.

-   **Red-necked Phalarope** - I am using the Phalarope spp. model here. Red Phalaropes and Red-necked Phalarope observations are both abundant in this model with high proportions of unidentified observations for each season. Wilson's Phalaropes are not included in this frameowrk for the reasons listed in section 1 of this overview.  

-   **Red Phalarope** - I am using the Phalarope spp. model here. Red Phalaropes and Red-necked Phalarope observations are both abundant in this model with high proportions of unidentified observations for each season. Wilson's Phalaropes are not included in this framework for the reasons listed in section 1 of this overview.

-   **Scripp's Murrelet** - I am using the Scripp's/Guadalupe/Craveri's Murrelet model for all three of these species. Based on the recent split between Scripp's and Guadalupe Murrelets and the high proportions of unidentified murrelet observations in the model it's challenging to piece out how representative this model is of each species.

-   **Guadalupe Murrelet** - I am using the Scripp's/Guadalupe/Craveri's Murrelet model for all three of these species. Based on the recent split between Scripp's and Guadalupe Murrelets and the high proportions of unidentified murrelet observations in the model it's challenging to piece out how representative this model is of each species.

-   **Craveri's Murrelet** - I am using the Scripp's/Guadalupe/Craveri's Murrelet model for all three of these species. Based on the recent split between Scripp's and Guadalupe Murrelets and the high proportions of unidentified murrelet observations in the model it's challenging to piece out how representative this model is of each species.

-   **Glaucous-winged Gull** - I am using the Glaucous-winged/Western Gull model, but the model is primarily representative of Western Gull distribution in all seasons.  

-   **Western Gull** - I am using the Glaucous-winged/Western Gull model, but the model is primarily representative of Western Gull distribution in all seasons.  

-   **Elegant Tern** - I am using the Royal/Elegant Tern model - this model is dominantly composed of Elegant Tern observations across seasons. Royal Terns are not included in this framework for the reasons listed in section 1 of this overview.

-   **Common Loon** - I am using the Common Loon model, which is only produced for Spring and Summer. There are minimal observations of Common Loons in the Fall and Winter, so this is unlikely to sway the distribution of this species significantly.

-   **Pacific Loon** - I am using the Loon spp model, which is primarily composed of Pacific Loon observations in all seasons.

-   **Yellow-billed Loon** - I am using the Loon spp model, which is primarily composed of Pacific Loon observations in all seasons. There are very few observations of Yellow-billed Loons present in the model as this species is not very abundant in the POCS, so this is effectively more like using Pacific Loon distribution as a proxy for this species.

-   **Red-throated Loon** - I am using the Red-throated Loon model, which is only produced for Spring and Summer. There are minimal observations of Red-throated in the Fall and Winter, so this is unlikely to sway the distribution of this species significantly.

-   **Double-crested Cormorant** - I am using the Double-crested Cormorant model, which is only produced for Spring and Summer. Cormorants were modeled as a unit for all seasons alongside the Spring/Summer individual species models given high rates of unidentified observations in the non-breeding season. Double-crested Cormorants are not present in high numbers in the fall and winter seasons, so the Spring and Summer distributions may be broadly representative of their annual exposure to the wind areas.

-   **Pelagic Cormorant** - I am using the Pelagic Cormorant model, which is only produced for Spring and Summer. Cormorants were modeled as a unit for all seasons alongside the Spring/Summer individual species models given high rates of unidentified observations in the non-breeding season. Pelagic Cormorants are not present in high numbers in the fall and winter seasons, so the Spring and Summer distributions may be broadly representative of their annual exposure to the wind areas.

-   **Brandt's Cormorant** - I am using the Brandt's Cormorant model, which is only produced for Spring and Summer. Cormorants were modeled as a unit for all seasons alongside the Spring/Summer individual species models given high rates of unidentified observations in the non-breeding season. Brandt's Cormorants are the dominant species in the Cormorant spp. model in the Fall and Winter seasons, but modeling the fall and winter seasons alone for the Cormorant spp. model produces a lower overlap for the entire region than modeling the Brandt's model alone (0.00048 vs 0.0007) so using the Brandt's model alone is the precautionary choice.

-   **Western Grebe** - I am using the Western/Clark's Grebe model. This model is almost entirely composed of Western Grebe observations.

-   **Clark's Grebe** - I am using the Western/Clark's Grebe model. This model is almost entirely composed of Western Grebe observations.

-   **Surf Scoter** - I am using the Scoter spp model for all scoters. This model is a significantly more composed of Surf and White-winged Scoter observations than it is of Black Scoter observations across seasons.

-   **Black Scoter** - I am using the Scoter spp model for all scoters. This model is a significantly more composed of Surf and White-winged Scoter observations than it is of Black Scoter observations across seasons.

-   **White-winged Scoter** - I am using the Scoter spp model for all scoters. This model is a significantly more composed of Surf and White-winged Scoter observations than it is of Black Scoter observations across seasons.

I'd be happy to hear thoughts on necessity of trying to find an alternate approach to estimating exposure for the species in these groups, particularly for Brandt's Cormorant?

Of the species that we consider regional, we don't have species distribution models for the following species:

```{r}
# Select the relevant data: 
nodata <- df %>% 
  filter(regional == "Y",
         is.na(exposure_model)) %>% 
  select(common_name, rescaled_propALL, rescaled_CV, rescaled_DV, iucn_status)

# Print the data frame as a styled table
kable(nodata, format = "html", col.names = c("Species", "CCS Exposure", "Collision Sensitivity", "Displacement Sensitivity", "IUCN Status"), table.attr = 'class="table table-striped"') %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

For these species, I'm exploring using expert elicitation or phylogenetic imputation to generate estimate values of overlap and ranges of uncertainty.

## Step 3 - Combining Values

I need to come back and fill in these sections when I have more of a brain. But right now, the exposure values range from 0-1, the sensitivity numbers range from 2/3 to 3/2, and the threat values are:

-   LC: 0.5623413

-   NT: 0.7498942

-   VU: 1.0000000

-   EN: 1.3335214

-   CR: 1.7782794

The equation to combine them is just:

$$
Priority = Exposure \times Sensitivity_{max} \times Threat
$$

Where exposure is ... \[TODO fill me out later\]

The output values are then split into four categories using the cut function.

Based on that, here is the plot of how it all shakes out:

```{r, fig.width=10.5, fig.height=7}

packages<- c("tidyverse", "here", "dplyr")

pacman::p_load(packages, character.only = TRUE); rm(packages)

# Part 2: Import Data -----------------------------------------------
alldat <- read_csv(here::here("data/processed_data/cleaned_data.csv"))

# Part 3: Rescaling values  -----------------------------------------------

#setting up values for rescaling
#assigning some arbitrary values to threat to start so I have something to work with
lookup <- tibble(
  iucn_status = c("LC", "NT", "VU", "EN", "CR"),
  iucn_value = c(0.5623413, 0.7498942, 1.0000000, 1.3335214, 1.7782794)
)
# Set a range to use for rescaling sensitivity
sens_min_new <- 2 / 3
sens_max_new <- 3 / 2

#create a dataframe with all the relevant numbers rescaled as necessary
rescaled_dat <- alldat %>% 
  #Remove species that don't have spatial data (come back to deal with these)
  filter(!is.na(exposure_model)) %>% 
  left_join(lookup, by = "iucn_status") %>% #join the values for IUCN status from above
  #rescaling CV, DV, and exposure from 0 to 1 to start, adding the 0.0001 to get rid of zeroes
  mutate(rescaled_propALL = (propALL - min(propALL)) / (max(propALL) - min(propALL)) +0.0001,
         rescaled_DV = (DV - min(DV)) / (max(DV) - min(DV)) +0.0001,
         rescaled_CV = (CV - min(CV)) / (max(CV) - min(CV)) +0.0001
  ) %>% 
  # add a single column to contain whichever of the rescaled CV or DV #s is higher, and state which number is used in a second column 
  mutate(
    highest_sens = pmax(rescaled_CV, rescaled_DV),
    highest_sens_source = case_when( #listing which is the higher value
      rescaled_DV > rescaled_CV ~ "DV",
      rescaled_CV > rescaled_DV ~ "CV",
      TRUE ~ "tie" # Handle the case when both values are equal 
    )
  ) %>% 
  #now rescale the sensitivity column to whatever min and max I define above
  mutate(
    rescaled_sensitivity = sens_min_new + (highest_sens - min(highest_sens)) * (sens_max_new - sens_min_new) / (max(highest_sens) - min(highest_sens))
  )

prioritizationdf <- rescaled_dat %>% 
  mutate(es = rescaled_propALL * rescaled_sensitivity,
         est = rescaled_propALL * rescaled_sensitivity * iucn_value,
         bin = cut(est, 4, labels = c("Low", "Moderate", "High", "Extreme")))

prioritizationdf %>% 
  mutate(origin = factor(rescaled_propALL)) %>% 
  pivot_longer(c(rescaled_propALL, es, est), names_to = "x", values_to = "y") %>% 
  mutate(
    x = factor(x, levels = c("rescaled_propALL", "es", "est"))  # Set the order of x-axis categories after pivoting
  ) %>% 
  ggplot(aes(x, y, group = alpha_code, color = origin)) +
  geom_line(aes(color = origin), show.legend = FALSE) +
  geom_point(aes(fill = bin), shape = 21, color = "white", size = 6) +
  geom_text(data = . %>% 
              group_by(alpha_code) %>% 
              filter(row_number() == n()),  # Get the last row of each group for labeling
            aes(label = alpha_code), 
            vjust = -0.5,  # Adjust vertical position
            hjust = -1,   # Adjust horizontal position
            size = 1.5) +   # Text size
  theme_classic() +
  guides(color = "none") +#gets rid of the legend for the line colors/origin points
  theme(
    legend.key.size = unit(0.1, 'cm'),  # Adjust the size of legend keys
    legend.text = element_text(size = 6)  # Adjust the text size in the legend
  )+
  scale_x_discrete(labels = c(
    "rescaled_propALL" = "Exposure", 
    "es" = "Exposure * Sensitivity", 
    "est" = "Exposure * Sensitivity * Threat"
  ))
```

And here are the bins and their values for reference:

#### Extreme:

```{r}
# Select the relevant data: 
extreme <- prioritizationdf %>% 
  filter(bin == "Extreme") %>% 
  arrange(desc(est)) %>% 
  select(common_name, rescaled_propALL, rescaled_CV, rescaled_DV, iucn_status, est)

# Print the data frame as a styled table
kable(extreme, 
      format = "html", 
      col.names = c("Species", "CCS Exposure", "Collision Sensitivity", 
                    "Displacement Sensitivity", "IUCN Status", "Priority Value"), 
      table.attr = 'class="table table-striped"',
      digits = 3) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

#### High:

```{r}
high <- prioritizationdf %>% 
  filter(bin == "High") %>% 
  arrange(desc(est)) %>% 
  select(common_name, rescaled_propALL, rescaled_CV, rescaled_DV, iucn_status, est)

# Print the data frame as a styled table
kable(high, format = "html", col.names = c("Species", "CCS Exposure", "Collision Sensitivity", "Displacement Sensitivity", "IUCN Status", "Priority Value"), table.attr = 'class="table table-striped"',
      digits = 3) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

#### Moderate:

```{r}
moderate <- prioritizationdf %>% 
  filter(bin == "Moderate") %>% 
  arrange(desc(est)) %>% 
  select(common_name, rescaled_propALL, rescaled_CV, rescaled_DV, iucn_status, est)

# Print the data frame as a styled table
kable(moderate, format = "html", col.names = c("Species", "CCS Exposure", "Collision Sensitivity", "Displacement Sensitivity", "IUCN Status", "Priority Value"), table.attr = 'class="table table-striped"',
      digits = 3) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

#### Low:

```{r}
low <- prioritizationdf %>% 
  filter(bin == "Low") %>% 
  arrange(desc(est)) %>% 
  select(common_name, rescaled_propALL, rescaled_CV, rescaled_DV, iucn_status, est)

# Print the data frame as a styled table
kable(low, format = "html", col.names = c("Species", "CCS Exposure", "Collision Sensitivity", "Displacement Sensitivity", "IUCN Status", "Priority Value"), table.attr = 'class="table table-striped"',
      digits = 3) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```
