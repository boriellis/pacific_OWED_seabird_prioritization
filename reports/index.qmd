---
output: html_document
format: 
  html:
    css: styles.css
execute:
  echo: false
  warning: false  # Suppress warnings
  message: false  # Suppress messages
editor_options: 
  chunk_output_type: console
---

# Species Prioritization Weight Testing

The point of this document is to explain each of the steps of the species prioritization framework for the California Current Ecosystem. This document is in progress.

## Step 1 - Selecting species present in the region to include

A literature review was performed to compile a list of all birds found regularly in the region. The initial list was acquired by combining the list from Kelsey et al. (2018) (detailed methods on the list formation can be found in Adams et al., 2016), which identified 81 regional marine bird species in the California Current System, with the list of species modeled by Leirness et al., 2021. The list was then refined according to the following additional criteria:\

-   The updated vulnerability index from Kelsey et al (in prep) includes eight additional species due to range shifts and taxonomic updates. We have followed suit and included these species here:

    -   Masked Booby, *Sula dactylatra*

        Nazca Booby, *Sula granti*

        Blue-footed Booby, *Sula nebouxii*

        Brown Booby, *Sula leucogaster*

        Red-footed Booby, *Sula sula*

        Red-billed Tropicbird, *Phaethon aethereus*

        Guadalupe Murrelet, *Synthliboramphus hypoleucus*

        Townsend’s Storm-Petrel, *Hydrobates socorroensis*

-   Species that were considered to have 1% or less of their global population utilizing the CCS by Adams et al 2016 and Kelsey et al 2018 were considered for exclusion from this list, as a metric to exclude vagrants. I have selected the 1% cutoff is based on precedent for use in definitions of [Birdlife International’s Important Bird Areas](http://datazone.birdlife.org/userfiles/images/Guidelines%20for%20the%20application%20of%20the%20IBA%20criteria_final%20approved%20version_July2020.pdf), the [EU Natura 2000 Site Guidelines for Marine Habitats](https://ec.europa.eu/environment/nature/natura2000/marine/docs/marine_guidelines.pdf). It was also used in [Desholm’s 2009](https://pubmed.ncbi.nlm.nih.gov/19299065/) prioritization framework for research needs for migratory birds in wind farms. These applications are all for definition of important bird areas at much finer scales than what we’re discussing here, but as I am here recommending that the 1% criteria be used simply as a first step for eliminating vagrants from regional consideration, I believe that it functions in this application as a tool to identify whether the region is important to a species globally.

    -   For all species with \<1% of global population estimated in the CCS, we performed literature review (primarily through the Cornell Birds of the World database) as a confirmation that the species is appropriate for exclusion. Local population estimates are frequently based on at-sea survey data that may be sufficient to identify certain types of important regional presence. Any species breeding in the CCS was included, even if local populations were small compared to global population sizes. Species known to have migratory pathways crossing the CCS were also included, as a precautionary measure given that brief periods of high bird presence during migration may be challenging to detect from at-sea survey data. Threatened species with poorly understood local area usage were also considered for inclusion.

Following the above steps, of the species that were considered in Leirness et al., 2021, Kelsey et al., 2018, and/or Kelsey et al., 2024, I opted to exclude the following species from this analysis for reasons described below:

-   **Wilson's Phalarope, *Phalaropus tricolor*** (Kelsey et al., 2018, 2024: N, Leirness et al., 2021: Y)

    -   Not included in original Kelsey et al., vulnerability index as the species does not typically use pelagic habitats. A handful of records from at-sea surveys meant that the species was modeled in the joint "Phalarope" model by Leirness et al., 2021. Excluded here because of very low offshore habitat usage (CITE).

-   **Short-tailed Shearwater, *Ardenna tenuirostris*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: Y)

    -   \<1% of global population considered to be in CCS by Kelsey et al 2018

    -   Included in joint Short-tailed, Flesh-footed, and Sooty Shearwater model by Leirness et al., 2021, based on low percentages of observations included in the model.

    -   Excluded because while data on local distribution is poor and outdated, there is no local breeding of the species and no known important migratory route through the CCS, just low usage in the non-breeding season (CITE)..

-   **Flesh-footed Shearwater, *Ardenna carneipes*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: Y)

    -   \<1% of global population considered to be in CCS by Kelsey et al 2018

    -   Included in joint Short-tailed, Flesh-footed, and Sooty Shearwater model by Leirness et al., 2021, based on low percentages of observations included in the model.

    -   Excluded because while data on local distribution is poor and outdated, there is no local breeding of the species and no known important migratory route through the CCS, just low usage in the non-breeding season (CITE).

-   **Arctic Loon, *Gavia arctica*** (Kelsey et al., 2018, 2024: N, Leirness et al., 2021: Y)

    -   This was formerly a subspecies of Pacific Loon, and is therefore only included in Leirness et al., 2021 as an artifact of the timing of the split. The species does not use the CCS (CITE).

-   **Common Tern, *Sterna hirundo*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: Y)

    -   \<1% of global population considered to be in CCS by Kelsey et al 2018

    -   Modeled as part of the Common Tern/Arctic Tern joint model by Leirness et al., 2021

    -   No breeding populations in the CCS, and no documented important migratory routes through offshore region (CITE).

-   **Royal Tern, *Thalasseus maximus*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: Y)

    -   \<1% of global population considered to be in CCS by Kelsey et al 2018

    -   Modeled as part of the Royal Tern/Elegant Tern joint model by Leirness et al., 2021

    -   Breeds irregularly in Southern California, but primarily uses inshore habitat; not considered highly pelagic (CITE).

-   **Horned Puffin, *Fratercula corniculata*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: N)

    -   \<1% of global population considered to be in CCS by Kelsey et al 2018

    -   Spend non-breeding season partially in pelagic CCS but not believed to overlap with the CCS in large numbers (CITE)

-   **Parakeet Auklet, *Aethia psittacula*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: N)

    -   \<1% of global population considered to be in CCS by Kelsey et al 2018

    -   Spend non-breeding season partially in pelagic CCS but not believed to overlap with the CCS in large numbers (CITE)

-   **Common Merganser, *Mergus merganser*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: N)

    -   \<1% of global population considered to be in CCS by Kelsey et al 2018

    -   Primarily use inshore and immediate coastal habitat (CITE).

-   **Red-breasted Merganser, *Mergus serrator*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: N)

    -   \<1% of global population considered to be in CCS by Kelsey et al 2018

    -   Primarily use inshore and immediate coastal habitat (CITE).

-   **Horned Grebe, *Podiceps auritus*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: N)

    -   \<1% of global population considered to be in CCS by Kelsey et al 2018

    -   Primarily use inshore and immediate coastal habitat (CITE).

-   **Long-tailed Duck, *Clangula hyemalis*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: N)

    -   \<1% of global population considered to be in CCS by Kelsey et al 2018

-   **Least Storm-Petrel, *Hydrobates microsoma*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: N)

    -   \<1% of global population considered to be in CCS by Kelsey et al 2018

    -   Occasionally found offshore as far north as central California in late summer but vast majority of population is in Gulf of California (CITE).

-   **Gull-billed Tern, *Gelochelidon nilotica*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: N)

    -   \<1% of global population considered to be in CCS by Kelsey et al 2018

    -   Primarily uses inshore habitat (CITE).

-   **Black Tern, *Chlidonias niger*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: N)

    -   \<1% of global population considered to be in CCS by Kelsey et al 2018

    -   Primarily uses inshore habitat, not found offshore in CCS (CITE).

-   **Wilson's Storm-Petrel, *Oceanites oceanicus*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: N)

    -   \<1% of global population considered to be in CCS by Kelsey et al 2018

    -   Uncommonly found in CCS in non-breeding season (CITE).

-   **American White Pelican, *Pelecanus erythrorhynchos*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: N)

    -   \<1% of global population considered to be in CCS by Kelsey et al 2018

    -   Not found in offshore habitat (CITE).

-   **Manx Shearwater, *Puffinus puffinus*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: N)

    -   \<1% of global population considered to be in CCS by Kelsey et al 2018

    -   Doesn't breed in region, only rarely found offshore (CITE).

The following table shows the exposure values, sensitivity values, and IUCN statuses for these species. Exposure and sensitivity values are each re-scaled to 1.

```{r}
# Load necessary libraries
suppressPackageStartupMessages(library(tidyverse)) # Suppress startup messages
library(knitr)
library(kableExtra) # Optional for further customization
library(tidyverse)
library(here)
#read in the csv:
df <- read.csv((here::here("data/processed_data/data_for_quarto.csv")))


# Select the relevant data: 
cleandf <- df %>% 
  filter(regional == "N") %>% 
  select(common_name, rescaled_propALL, rescaled_CV, rescaled_DV, iucn_status)

# Print the data frame as a styled table
kable(cleandf, format = "html", col.names = c("Species", "CCS Exposure", "Collision Sensitivity", "Displacement Sensitivity", "IUCN Status"), table.attr = 'class="table table-striped"') %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

The following species were included in the analysis despite a global population overlap with the CCS estimated by Kelsey et al., 2018 to be \<1%, for the reasons stated:

-   **Hawaiian Petrel, *Pterodroma sandwichensis*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: N)

    -   Included to be precautionary because of endangered IUCN status and an abundance of eBird sightings in recent years (CITE).

-   **Fork-tailed Storm-Petrel, *Hydrobates furcatus*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: Y)

    -   Included because the species breeds in the CCS (CITE).

-   **Parasitic Jaeger, *Stercorarius parasiticus*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: Y)

    -   Understood to migrate through the CCS, but limited research on movement and abundance data throughout the region (CITE) - included to be precautionary as migratory movements may be challenging to pick up in at-sea survey data.

-   **Long-tailed Jaeger, *Stercorarius longicaudus*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: Y)

    -   Understood to migrate through the CCS, but limited research on movement and abundance data throughout the region (CITE) - included to be precautionary as migratory movements may be challenging to pick up in at-sea survey data.

-   **Black Storm-Petrel, *Hydrobates melania*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: Y)

    -   Included because the species breeds in the CCS (CITE).

-   **Laysan Albatross, *Phoebastria immutabilis*** (Kelsey et al., 2018, 2024: Y, Leirness et al., 2021: Y)

    -   Included precautionarily given breeding population on Guadalupe Island and given proposed translocation to establish breeding colonies on the Channel Islands (Raine et al., 2022)

The following table shows the exposure values, sensitivity values, and IUCN statuses for these species. Again, exposure and sensitivity values are each re-scaled to 1.

```{r}
# Select the relevant data: 
cleandf <- df %>% 
  filter(CCSpop_Score == "1",
         regional == "Y") %>% 
  select(common_name, rescaled_propALL, rescaled_CV, rescaled_DV, iucn_status)

# Print the data frame as a styled table
kable(cleandf, format = "html", col.names = c("Species", "CCS Exposure", "Collision Sensitivity", "Displacement Sensitivity", "IUCN Status"), table.attr = 'class="table table-striped"') %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

## Step 2 - Combining values

Here is a list of the species that we don't have Jeff's models for:

```{r}
# Select the relevant data: 
nodata <- df %>% 
  filter(regional == "Y",
         is.na(exposure_model)) %>% 
  select(common_name, rescaled_propALL, rescaled_CV, rescaled_DV, iucn_status)

# Print the data frame as a styled table
kable(nodata, format = "html", col.names = c("Species", "CCS Exposure", "Collision Sensitivity", "Displacement Sensitivity", "IUCN Status"), table.attr = 'class="table table-striped"') %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

I need to come back and fill in these sections when I have more of a brain. But right now, the exposure values range from 0-1, the sensitivity numbers range from 2/3 to 3/2, and the threat values are:

-   LC: 0.5623413

-   NT: 0.7498942

-   VU: 1.0000000

-   EN: 1.3335214

-   CR: 1.7782794

The equation to combine them is just:

$$
Priority = Exposure \times Sensitivity_{max} \times Threat
$$

Where exposure is ... \[TODO fill me out later\]

The output values are then split into four categories using the cut function.

Based on that, here is the plot of how it all shakes out:

```{r, fig.width=10.5, fig.height=7}

packages<- c("tidyverse", "here", "dplyr")

pacman::p_load(packages, character.only = TRUE); rm(packages)

# Part 2: Import Data -----------------------------------------------
alldat <- read_csv(here::here("data/processed_data/cleaned_data.csv"))

# Part 3: Rescaling values  -----------------------------------------------

#setting up values for rescaling
#assigning some arbitrary values to threat to start so I have something to work with
lookup <- tibble(
  iucn_status = c("LC", "NT", "VU", "EN", "CR"),
  iucn_value = c(0.5623413, 0.7498942, 1.0000000, 1.3335214, 1.7782794)
)
# Set a range to use for rescaling sensitivity
sens_min_new <- 2 / 3
sens_max_new <- 3 / 2

#create a dataframe with all the relevant numbers rescaled as necessary
rescaled_dat <- alldat %>% 
  #Remove species that don't have spatial data (come back to deal with these)
  filter(!is.na(exposure_model)) %>% 
  left_join(lookup, by = "iucn_status") %>% #join the values for IUCN status from above
  #rescaling CV, DV, and exposure from 0 to 1 to start, adding the 0.0001 to get rid of zeroes
  mutate(rescaled_propALL = (propALL - min(propALL)) / (max(propALL) - min(propALL)) +0.0001,
         rescaled_DV = (DV - min(DV)) / (max(DV) - min(DV)) +0.0001,
         rescaled_CV = (CV - min(CV)) / (max(CV) - min(CV)) +0.0001
  ) %>% 
  # add a single column to contain whichever of the rescaled CV or DV #s is higher, and state which number is used in a second column 
  mutate(
    highest_sens = pmax(rescaled_CV, rescaled_DV),
    highest_sens_source = case_when( #listing which is the higher value
      rescaled_DV > rescaled_CV ~ "DV",
      rescaled_CV > rescaled_DV ~ "CV",
      TRUE ~ "tie" # Handle the case when both values are equal 
    )
  ) %>% 
  #now rescale the sensitivity column to whatever min and max I define above
  mutate(
    rescaled_sensitivity = sens_min_new + (highest_sens - min(highest_sens)) * (sens_max_new - sens_min_new) / (max(highest_sens) - min(highest_sens))
  )

prioritizationdf <- rescaled_dat %>% 
  mutate(es = rescaled_propALL * rescaled_sensitivity,
         est = rescaled_propALL * rescaled_sensitivity * iucn_value,
         bin = cut(est, 4, labels = c("Low", "Moderate", "High", "Extreme")))

prioritizationdf %>% 
  mutate(origin = factor(rescaled_propALL)) %>% 
  pivot_longer(c(rescaled_propALL, es, est), names_to = "x", values_to = "y") %>% 
  mutate(
    x = factor(x, levels = c("rescaled_propALL", "es", "est"))  # Set the order of x-axis categories after pivoting
  ) %>% 
  ggplot(aes(x, y, group = alpha_code, color = origin)) +
  geom_line(aes(color = origin), show.legend = FALSE) +
  geom_point(aes(fill = bin), shape = 21, color = "white", size = 6) +
  geom_text(data = . %>% 
              group_by(alpha_code) %>% 
              filter(row_number() == n()),  # Get the last row of each group for labeling
            aes(label = alpha_code), 
            vjust = -0.5,  # Adjust vertical position
            hjust = -1,   # Adjust horizontal position
            size = 1.5) +   # Text size
  theme_classic() +
  guides(color = "none") +#gets rid of the legend for the line colors/origin points
  theme(
    legend.key.size = unit(0.1, 'cm'),  # Adjust the size of legend keys
    legend.text = element_text(size = 6)  # Adjust the text size in the legend
  )+
  scale_x_discrete(labels = c(
    "rescaled_propALL" = "Exposure", 
    "es" = "Exposure * Sensitivity", 
    "est" = "Exposure * Sensitivity * Threat"
  ))
```

And here are the bins and their values for reference:

#### Extreme:

```{r}
# Select the relevant data: 
extreme <- prioritizationdf %>% 
  filter(bin == "Extreme") %>% 
  arrange(desc(est)) %>% 
  select(common_name, rescaled_propALL, rescaled_CV, rescaled_DV, iucn_status, est)

# Print the data frame as a styled table
kable(extreme, 
      format = "html", 
      col.names = c("Species", "CCS Exposure", "Collision Sensitivity", 
                    "Displacement Sensitivity", "IUCN Status", "Priority Value"), 
      table.attr = 'class="table table-striped"',
      digits = 3) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

#### High:

```{r}
high <- prioritizationdf %>% 
  filter(bin == "High") %>% 
  arrange(desc(est)) %>% 
  select(common_name, rescaled_propALL, rescaled_CV, rescaled_DV, iucn_status, est)

# Print the data frame as a styled table
kable(high, format = "html", col.names = c("Species", "CCS Exposure", "Collision Sensitivity", "Displacement Sensitivity", "IUCN Status", "Priority Value"), table.attr = 'class="table table-striped"',
      digits = 3) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

#### Moderate:

```{r}
moderate <- prioritizationdf %>% 
  filter(bin == "Moderate") %>% 
  arrange(desc(est)) %>% 
  select(common_name, rescaled_propALL, rescaled_CV, rescaled_DV, iucn_status, est)

# Print the data frame as a styled table
kable(moderate, format = "html", col.names = c("Species", "CCS Exposure", "Collision Sensitivity", "Displacement Sensitivity", "IUCN Status", "Priority Value"), table.attr = 'class="table table-striped"',
      digits = 3) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

#### Low:

```{r}
low <- prioritizationdf %>% 
  filter(bin == "Low") %>% 
  arrange(desc(est)) %>% 
  select(common_name, rescaled_propALL, rescaled_CV, rescaled_DV, iucn_status, est)

# Print the data frame as a styled table
kable(low, format = "html", col.names = c("Species", "CCS Exposure", "Collision Sensitivity", "Displacement Sensitivity", "IUCN Status", "Priority Value"), table.attr = 'class="table table-striped"',
      digits = 3) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```
